import React, { useState, useEffect, createContext, useContext, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc } from 'firebase/firestore';
import Chart from 'chart.js/auto'; // Chart.js v3+

// Firebase 설정 및 초기화
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-travel-planner-app';

// Context 생성
const AppContext = createContext();

// 숫자 포맷팅 함수 (예: 1,000,000원)
const formatKRW = (amount) => {
    return new Intl.NumberFormat('ko-KR').format(amount);
};

// 환율 정보
const EXCHANGE_RATES = {
    'EUR': 1610, // 1유로당 1610원
    'CZK': 65,   // 1코루나당 65원
    'USD': 1350  // 1달러당 1350원
};

// 금액을 원화로 변환하는 함수
const convertToKRW = (amount, currency) => {
    if (currency === 'KRW') {
        return amount;
    }
    const rate = EXCHANGE_RATES[currency];
    return amount * rate;
};

// CustomModal Component
const CustomModal = ({ isOpen, type, title, message, inputLabel, inputValue, onConfirm, onCancel, onInputChange, inputType = 'text', children }) => {
    if (!isOpen) return null;

    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            onConfirm(inputValue);
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 className="text-xl font-bold mb-4 text-teal-700">{title}</h3>
                {message && <p className="mb-4 text-slate-700">{message}</p>}
                {type === 'prompt' && (
                    <input
                        type={inputType}
                        className="w-full p-2 border border-slate-300 rounded-md mb-4 focus:ring-teal-500 focus:border-teal-500"
                        placeholder={inputLabel}
                        value={inputValue}
                        onChange={onInputChange}
                        onKeyDown={handleKeyDown} // Add keydown listener
                        autoFocus
                    />
                )}
                {children} {/* Render children for complex forms */}
                <div className="flex justify-end space-x-3 mt-4">
                    {type !== 'alert' && (
                        <button onClick={onCancel} className="bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-md hover:bg-slate-400 transition">
                            취소
                        </button>
                    )}
                    <button onClick={() => onConfirm(inputValue)} onKeyDown={handleKeyDown} className="bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition">
                        확인
                    </button>
                </div>
            </div>
        </div>
    );
};

// AddBookingModal Component
const AddBookingModal = ({ isOpen, onClose, onSave }) => {
    const [type, setType] = useState('');
    const [name, setName] = useState('');
    const [ref, setRef] = useState('');
    const [checkin, setCheckin] = useState('');
    const [checkout, setCheckout] = useState('');
    const [from, setFrom] = useState('');
    const [to, setTo] = useState('');
    const [departure, setDeparture] = useState('');
    const [arrival, setArrival] = useState('');
    const [boardingDate, setBoardingDate] = useState(''); // New: Boarding Date
    const [tourDate, setTourDate] = useState(''); // Changed from 'date' to 'tourDate' to avoid conflict
    const [tourStartTime, setTourStartTime] = useState(''); // New: Tour Start Time
    const [tourEndTime, setTourEndTime] = useState(''); // New: Tour End Time
    const [meetingPoint, setMeetingPoint] = useState('');
    const [notes, setNotes] = useState('');
    const [otherDate, setOtherDate] = useState(''); // For Dining/Other
    const [otherTime, setOtherTime] = useState(''); // For Dining/Other

    useEffect(() => {
        // Reset state when modal opens
        if (isOpen) {
            setType('');
            setName('');
            setRef('');
            setCheckin('');
            setCheckout('');
            setFrom('');
            setTo('');
            setDeparture('');
            setArrival('');
            setBoardingDate(''); // Reset boarding date
            setTourDate('');
            setTourStartTime(''); // Reset tour start time
            setTourEndTime(''); // Reset tour end time
            setMeetingPoint('');
            setNotes('');
            setOtherDate('');
            setOtherTime('');
        }
    }, [isOpen]);

    const handleSave = () => {
        if (!type || !name || !ref) {
            alert("예약 유형, 예약명, 예약 번호는 필수 입력 항목입니다.");
            return;
        }

        const newBooking = { id: crypto.randomUUID(), type, name, ref, notes };

        if (type === "숙소") {
            newBooking.checkin = checkin;
            newBooking.checkout = checkout;
        } else if (type === "항공" || type === "열차" || type === "버스") { // Added '버스'
            newBooking.boardingDate = boardingDate; // Add boarding date
            newBooking.from = from;
            newBooking.to = to;
            newBooking.departure = departure;
            newBooking.arrival = arrival;
        } else if (type === "투어") {
            newBooking.date = tourDate; // Use tourDate
            newBooking.startTime = tourStartTime; // Use tourStartTime
            newBooking.endTime = tourEndTime; // Use tourEndTime
            newBooking.meetingPoint = meetingPoint;
        } else if (type === "식사" || type === "기타") { // New types
            newBooking.date = otherDate;
            newBooking.time = otherTime;
        }
        onSave(newBooking);
        onClose();
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleSave();
        }
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
                <h3 className="text-xl font-bold mb-4 text-teal-700">새 예약 추가</h3>
                <div className="space-y-3">
                    <div>
                        <label className="block text-sm font-medium text-slate-700">예약 유형</label>
                        <select
                            className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                            value={type}
                            onChange={(e) => setType(e.target.value)}
                            onKeyDown={handleKeyDown}
                        >
                            <option value="">선택하세요</option>
                            <option value="항공">항공</option>
                            <option value="열차">열차</option>
                            <option value="버스">버스</option> {/* Added Bus */}
                            <option value="숙소">숙소</option>
                            <option value="투어">투어</option>
                            <option value="식사">식사</option> {/* New: Dining */}
                            <option value="기타">기타</option> {/* New: Other */}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700">예약명</label>
                        <input
                            type="text"
                            className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            onKeyDown={handleKeyDown}
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700">예약 번호</label>
                        <input
                            type="text"
                            className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                            value={ref}
                            onChange={(e) => setRef(e.target.value)}
                            onKeyDown={handleKeyDown}
                        />
                    </div>

                    {type === '숙소' && (
                        <>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">체크인 날짜</label>
                                <input
                                    type="date"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={checkin}
                                    onChange={(e) => setCheckin(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">체크아웃 날짜</label>
                                <input
                                    type="date"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={checkout}
                                    onChange={(e) => setCheckout(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                        </>
                    )}

                    {(type === '항공' || type === '열차' || type === '버스') && ( // Added '버스'
                        <>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">탑승일</label> {/* New Field */}
                                <input
                                    type="date"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={boardingDate}
                                    onChange={(e) => setBoardingDate(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">출발지</label>
                                <input
                                    type="text"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={from}
                                    onChange={(e) => setFrom(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">도착지</label>
                                <input
                                    type="text"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={to}
                                    onChange={(e) => setTo(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">출발 시간</label>
                                <input
                                    type="time"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={departure}
                                    onChange={(e) => setDeparture(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">도착 시간</label>
                                <input
                                    type="time"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={arrival}
                                    onChange={(e) => setArrival(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                        </>
                    )}

                    {type === '투어' && (
                        <>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">투어 날짜</label>
                                <input
                                    type="date"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={tourDate} // Use tourDate
                                    onChange={(e) => setTourDate(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">투어 시작 시간</label> {/* Changed label */}
                                <input
                                    type="time"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={tourStartTime} // Use tourStartTime
                                    onChange={(e) => setTourStartTime(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">투어 종료 시간</label> {/* New Field */}
                                <input
                                    type="time"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={tourEndTime} // Use tourEndTime
                                    onChange={(e) => setTourEndTime(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">미팅 장소</label>
                                <input
                                    type="text"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={meetingPoint}
                                    onChange={(e) => setMeetingPoint(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                        </>
                    )}

                    {(type === '식사' || type === '기타') && ( // Fields for new types
                        <>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">날짜</label>
                                <input
                                    type="date"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={otherDate}
                                    onChange={(e) => setOtherDate(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700">시간</label>
                                <input
                                    type="time"
                                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={otherTime}
                                    onChange={(e) => setOtherTime(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                />
                            </div>
                        </>
                    )}

                    <div>
                        <label className="block text-sm font-medium text-slate-700">메모 (선택 사항)</label>
                        <textarea
                            className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            onKeyDown={handleKeyDown}
                        ></textarea>
                    </div>
                </div>
                <div className="flex justify-end space-x-3 mt-4">
                    <button onClick={onClose} className="bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-md hover:bg-slate-400 transition">
                        취소
                    </button>
                    <button onClick={handleSave} onKeyDown={handleKeyDown} className="bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition">
                        저장
                    </button>
                </div>
            </div>
        </div>
    );
};

// AddContactModal Component
const AddContactModal = ({ isOpen, onClose, onSave }) => {
    const [name, setName] = useState('');
    const [info, setInfo] = useState('');
    const [notes, setNotes] = useState(''); // New: Notes for contact

    useEffect(() => {
        // Reset state when modal opens
        if (isOpen) {
            setName('');
            setInfo('');
            setNotes(''); // Reset notes
        }
    }, [isOpen]);

    const handleSave = () => {
        if (!name || !info) {
            alert("연락처 이름과 정보는 필수 입력 항목입니다.");
            return;
        }
        onSave({ id: crypto.randomUUID(), name, info, notes }); // Pass notes
        onClose();
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleSave();
        }
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 className="text-xl font-bold mb-4 text-teal-700">새 연락처 추가</h3>
                <div className="space-y-3">
                    <div>
                        <label className="block text-sm font-medium text-slate-700">연락처 이름</label>
                        <input
                            type="text"
                            className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            onKeyDown={handleKeyDown}
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700">연락처 정보</label>
                        <textarea
                            className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                            value={info}
                            onChange={(e) => setInfo(e.target.value)}
                            onKeyDown={handleKeyDown}
                        ></textarea>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700">메모 (선택 사항)</label> {/* New Field */}
                        <textarea
                            className="w-full p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            onKeyDown={handleKeyDown}
                        ></textarea>
                    </div>
                </div>
                <div className="flex justify-end space-x-3 mt-4">
                    <button onClick={onClose} className="bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-md hover:bg-slate-400 transition">
                        취소
                    </button>
                    <button onClick={handleSave} onKeyDown={handleKeyDown} className="bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition">
                        저장
                    </button>
                </div>
            </div>
        </div>
    );
};


// AppContext Provider 컴포넌트
const AppProvider = ({ children }) => {
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [itineraries, setItineraries] = useState({});
    const [expenses, setExpenses] = useState({});
    const [checklist, setChecklist] = useState({});
    const [details, setDetails] = useState({
        customTitle: "체코 여행",
        theme: "유럽 배낭여행",
        destination: "체코 프라하",
        startDate: "2025-08-04",
        endDate: "2025-08-13",
        travelers: "나",
        expectedBudget: 2500000,
        bookings: [],
        contacts: []
    });
    const [currentPage, setCurrentPage] = useState('dashboard');

    // Modal state and functions
    const [modalState, setModalState] = useState({
        isOpen: false,
        type: '', // 'alert', 'confirm', 'prompt'
        title: '',
        message: '',
        inputLabel: '',
        inputValue: '', // For prompt input
        onConfirm: null,
        onCancel: null,
        inputType: 'text' // New: default input type
    });

    const handleModalInputChange = (e) => {
        setModalState(prev => ({ ...prev, inputValue: e.target.value }));
    };

    const openAlert = (message, title = '알림') => {
        setModalState({ isOpen: true, type: 'alert', title, message, onConfirm: () => setModalState({ ...modalState, isOpen: false }) });
    };

    const openConfirm = (message, title = '확인', onConfirmCallback) => {
        setModalState({
            isOpen: true,
            type: 'confirm',
            title,
            message,
            onConfirm: (value) => { // onConfirm now receives value
                onConfirmCallback(true, value);
                setModalState(prev => ({ ...prev, isOpen: false }));
            },
            onCancel: () => {
                onConfirmCallback(false);
                setModalState(prev => ({ ...prev, isOpen: false }));
            }
        });
    };

    const openPrompt = (message, title = '입력', inputLabel = '', defaultValue = '', inputType = 'text') => {
        return new Promise((resolve) => {
            setModalState({
                isOpen: true,
                type: 'prompt',
                title,
                message,
                inputLabel,
                inputValue: defaultValue,
                inputType, // Pass inputType to modalState
                onConfirm: (valueFromModal) => { // Accept value from modal
                    resolve(valueFromModal);
                    setModalState(prev => ({ ...prev, isOpen: false, inputValue: '' }));
                },
                onCancel: () => {
                    resolve(null);
                    setModalState(prev => ({ ...prev, isOpen: false, inputValue: '' }));
                }
            });
        });
    };


    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            if (user) {
                setUserId(user.uid);
            } else {
                if (typeof __initial_auth_token !== 'undefined') {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        setUserId(auth.currentUser.uid);
                    } catch (error) {
                        console.error("Custom token sign-in failed:", error);
                        try {
                            await signInAnonymously(auth);
                            setUserId(auth.currentUser.uid);
                        } catch (anonError) {
                            console.error("Anonymous sign-in failed:", anonError);
                        }
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                        setUserId(auth.currentUser.uid);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                    }
                }
            }
            setIsAuthReady(true);
        });
        return () => unsubscribe();
    }, []);

    // 데이터 로드 (userId가 준비되면)
    useEffect(() => {
        if (isAuthReady && userId) {
            // Itinerary 데이터 로드
            const itineraryRef = collection(db, `artifacts/${appId}/users/${userId}/itineraries`);
            const unsubscribeItinerary = onSnapshot(itineraryRef, (snapshot) => {
                const data = {};
                snapshot.forEach(doc => {
                    data[doc.id] = doc.data();
                });
                setItineraries(data);
                console.log("Itineraries updated in AppProvider:", data); // Debugging log
            }, (error) => console.error("Error fetching itineraries:", error));

            // Expense 데이터 로드
            const expenseRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
            const unsubscribeExpense = onSnapshot(expenseRef, (snapshot) => {
                const data = {};
                snapshot.forEach(doc => {
                    data[doc.id] = doc.data();
                });
                setExpenses(data);
                console.log("Expenses updated in AppProvider:", data); // Debugging log
            }, (error) => console.error("Error fetching expenses:", error));

            // Checklist 데이터 로드 (단일 문서)
            const checklistDocRef = doc(db, `artifacts/${appId}/users/${userId}/checklists`, 'myChecklist');
            const unsubscribeChecklist = onSnapshot(checklistDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    setChecklist(docSnap.data());
                } else {
                    // 문서가 없으면 기본값 설정 (dlfwjd.html의 checklist 구조 반영)
                    const defaultChecklist = {
                        "필수 서류": [
                            { id: crypto.randomUUID(), item: "여권", checked: false, notes: "만료일 확인" },
                            { id: crypto.randomUUID(), item: "항공권 (E-티켓)", checked: false, notes: "" },
                            { id: crypto.randomUUID(), item: "숙소 바우처", checked: false, notes: "" },
                        ],
                        "전자 기기": [
                            { id: crypto.randomUUID(), item: "휴대폰", checked: false, notes: "" },
                            { id: crypto.randomUUID(), item: "충전기, 보조배터리", checked: false, notes: "" },
                            { id: crypto.randomUUID(), item: "변압기, 어댑터", checked: false, notes: "유럽형" },
                        ],
                        "상비약": [
                            { id: crypto.randomUUID(), item: "소화제", checked: false, notes: "" },
                            { id: crypto.randomUUID(), item: "진통제", checked: false, notes: "" },
                        ],
                        "의류": [],
                        "세면도구": [],
                        "기타": []
                    };
                    setChecklist(defaultChecklist);
                    setDoc(checklistDocRef, defaultChecklist);
                }
            }, (error) => console.error("Error fetching checklist:", error));

            // Details 데이터 로드 (단일 문서)
            const detailsDocRef = doc(db, `artifacts/${appId}/users/${userId}/details`, 'myDetails');
            const unsubscribeDetails = onSnapshot(detailsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    setDetails(docSnap.data());
                } else {
                    // 문서가 없으면 기본값 설정 (dlfwjd.html의 info, bookings, contacts 구조 반영)
                    const defaultDetails = {
                        customTitle: "체코 여행",
                        theme: "유럽 배낭여행",
                        destination: "체코 프라하",
                        startDate: "2025-08-04",
                        endDate: "2025-08-13",
                        travelers: "나",
                        expectedBudget: 2500000,
                        bookings: [],
                        contacts: []
                    };
                    setDetails(defaultDetails);
                    setDoc(detailsDocRef, defaultDetails);
                }
            }, (error) => console.error("Error fetching details:", error));

            return () => {
                unsubscribeItinerary();
                unsubscribeExpense();
                unsubscribeChecklist();
                unsubscribeDetails();
            };
        }
    }, [isAuthReady, userId]);

    const value = {
        userId,
        isAuthReady,
        itineraries,
        setItineraries,
        expenses,
        setExpenses,
        checklist,
        setChecklist,
        details,
        setDetails,
        currentPage,
        setCurrentPage,
        db,
        appId,
        openAlert, // Pass modal functions
        openConfirm,
        openPrompt,
        modalState,
        handleModalInputChange
    };

    return (
        <AppContext.Provider value={value}>
            {children}
            <CustomModal
                isOpen={modalState.isOpen}
                type={modalState.type}
                title={modalState.title}
                message={modalState.message}
                inputLabel={modalState.inputLabel}
                inputValue={modalState.inputValue}
                onConfirm={modalState.onConfirm}
                onCancel={modalState.onCancel}
                onInputChange={handleModalInputChange}
                inputType={modalState.inputType} // Pass inputType to CustomModal
            />
        </AppContext.Provider>
    );
};


// 인라인 편집 가능한 텍스트 컴포넌트
const EditableText = ({ value, onSave, className = '', placeholder = '' }) => {
    const [isEditing, setIsEditing] = useState(false);
    const [currentValue, setCurrentValue] = useState(value);
    const inputRef = useRef(null);

    useEffect(() => {
        setCurrentValue(value);
    }, [value]);

    const handleDoubleClick = () => {
        setIsEditing(true);
    };

    const handleBlur = () => {
        setIsEditing(false);
        if (currentValue !== value) {
            onSave(currentValue);
        }
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevent new line
            inputRef.current.blur();
        }
    };

    return isEditing ? (
        <input
            ref={inputRef}
            type="text"
            value={currentValue}
            onChange={(e) => setCurrentValue(e.target.value)}
            onBlur={handleBlur}
            onKeyDown={handleKeyDown}
            className={`w-full p-1 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 ${className}`}
            autoFocus
            placeholder={placeholder}
        />
    ) : (
        <span
            onDoubleClick={handleDoubleClick}
            className={`cursor-pointer ${className}`}
        >
            {value || placeholder}
        </span>
    );
};

// 인라인 편집 가능한 숫자 컴포넌트
const EditableNumber = ({ value, onSave, className = '', placeholder = '' }) => {
    const [isEditing, setIsEditing] = useState(false);
    const [currentValue, setCurrentValue] = useState(value);
    const inputRef = useRef(null);

    useEffect(() => {
        setCurrentValue(value);
    }, [value]);

    const handleDoubleClick = () => {
        setIsEditing(true);
    };

    const handleBlur = () => {
        setIsEditing(false);
        const parsedValue = parseFloat(currentValue);
        if (!isNaN(parsedValue) && parsedValue !== value) {
            onSave(parsedValue);
        } else if (isNaN(parsedValue) && value !== 0) { // Handle case where input becomes empty/invalid
            onSave(0); // Or revert to original value
        }
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            inputRef.current.blur();
        }
    };

    return isEditing ? (
        <input
            ref={inputRef}
            type="number"
            value={currentValue}
            onChange={(e) => setCurrentValue(e.target.value)}
            onBlur={handleBlur}
            onKeyDown={handleKeyDown}
            className={`w-full p-1 border rounded-md text-sm text-right focus:outline-none focus:ring-2 focus:ring-teal-500 ${className}`}
            autoFocus
            placeholder={placeholder}
        />
    ) : (
        <span
            onDoubleClick={handleDoubleClick}
            className={`cursor-pointer ${className}`}
        >
            {formatKRW(value) || placeholder}
        </span>
    );
};

// 인라인 편집 가능한 날짜 컴포넌트
const EditableDate = ({ value, onSave, className = '', placeholder = '' }) => {
    const [isEditing, setIsEditing] = useState(false);
    const [currentValue, setCurrentValue] = useState(value);
    const inputRef = useRef(null);

    useEffect(() => {
        setCurrentValue(value);
    }, [value]);

    const handleDoubleClick = () => {
        setIsEditing(true);
    };

    const handleBlur = () => {
        setIsEditing(false);
        if (currentValue && currentValue !== value) {
            onSave(currentValue);
        }
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            inputRef.current.blur();
        }
    };

    return isEditing ? (
        <input
            ref={inputRef}
            type="date"
            value={currentValue}
            onChange={(e) => setCurrentValue(e.target.value)}
            onBlur={handleBlur}
            onKeyDown={handleKeyDown}
            className={`w-full p-1 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 ${className}`}
            autoFocus
        />
    ) : (
        <span
            onDoubleClick={handleDoubleClick}
            className={`cursor-pointer ${className}`}
        >
            {value || placeholder}
        </span>
    );
};

// Helper function to group and sort bookings
const groupAndSortBookings = (bookings) => {
    const grouped = {};
    bookings.forEach(booking => {
        if (!grouped[booking.type]) {
            grouped[booking.type] = [];
        }
        grouped[booking.type].push(booking);
    });

    // Sort each group internally by time
    Object.keys(grouped).forEach(type => {
        grouped[type].sort((a, b) => {
            let timeA, timeB;
            if (a.type === '숙소') {
                timeA = a.checkin ? new Date(a.checkin).getTime() : 0;
                timeB = b.checkin ? new Date(b.checkin).getTime() : 0;
            } else if (a.type === '항공' || a.type === '열차' || a.type === '버스') {
                timeA = a.boardingDate && a.departure ? new Date(`${a.boardingDate}T${a.departure}`).getTime() : 0;
                timeB = b.boardingDate && b.departure ? new Date(`${b.boardingDate}T${b.departure}`).getTime() : 0;
            } else if (a.type === '투어') {
                timeA = a.date && a.startTime ? new Date(`${a.date}T${a.startTime}`).getTime() : 0;
                timeB = b.date && b.startTime ? new Date(`${b.date}T${b.startTime}`).getTime() : 0;
            } else if (a.type === '식사' || a.type === '기타') { // New types
                timeA = a.date && a.time ? new Date(`${a.date}T${a.time}`).getTime() : 0;
                timeB = b.date && b.time ? new Date(`${b.date}T${b.time}`).getTime() : 0;
            }
            else {
                timeA = 0;
                timeB = 0;
            }
            return timeA - timeB;
        });
    });

    return grouped;
};


// SummaryPage (Dashboard)
const SummaryPage = () => {
    const { itineraries, expenses, details, userId, db, appId, setDetails } = useContext(AppContext);
    const budgetChartRef = useRef(null);
    const budgetChartInstance = useRef(null);

    const today = new Date();
    today.setHours(0, 0, 0, 0); // Explicitly normalize today to start of day
    // Get local date components for display and string comparison
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-indexed
    const day = today.getDate().toString().padStart(2, '0');
    const todayString = `${year}-${month}-${day}`; // YYYY-MM-DD 형식

    const todayItinerary = itineraries[todayString]?.activities || [];
    const totalSpent = Object.values(expenses).reduce((sum, day) => sum + day.items.reduce((daySum, item) => daySum + (item.amount || 0), 0), 0);
    const todaySpent = expenses[todayString]?.items?.reduce((sum, item) => sum + (item.amount || 0), 0) || 0;
    const remainingBudget = (details.expectedBudget || 0) - totalSpent;

    // D-Day 계산
    const calculateDDay = (startDateStr) => {
        const start = new Date(startDateStr);
        start.setHours(0, 0, 0, 0);
        const todayAtMidnight = new Date();
        todayAtMidnight.setHours(0, 0, 0, 0);

        const diffTime = start - todayAtMidnight;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays > 0) return `D-${diffDays}`;
        if (diffDays === 0) return "D-Day";
        return "여행 중";
    };

    // 오늘의 주요 예약 필터링 및 정렬
    const todayBookings = details.bookings.filter(booking => {
        let bookingStart, bookingEnd;

        if (booking.type === '숙소' && booking.checkin && booking.checkout) {
            bookingStart = new Date(booking.checkin);
            bookingEnd = new Date(booking.checkout);
            bookingStart.setHours(0,0,0,0);
            bookingEnd.setHours(0,0,0,0);
            return today >= bookingStart && today <= bookingEnd;
        } else if ((booking.type === '항공' || booking.type === '열차' || booking.type === '버스') && booking.boardingDate) {
            bookingStart = new Date(booking.boardingDate);
            bookingStart.setHours(0,0,0,0);
            return today.getTime() === bookingStart.getTime();
        } else if (booking.type === '투어' && booking.date) {
            bookingStart = new Date(booking.date);
            bookingStart.setHours(0,0,0,0);
            return today.getTime() === bookingStart.getTime();
        } else if ((booking.type === '식사' || booking.type === '기타') && booking.date) { // New types
            bookingStart = new Date(booking.date);
            bookingStart.setHours(0,0,0,0);
            return today.getTime() === bookingStart.getTime();
        }
        return false;
    });

    const groupedTodayBookings = groupAndSortBookings(todayBookings);
    const sortedBookingTypes = Object.keys(groupedTodayBookings).sort();

    // Debugging: Log state changes to confirm real-time updates
    useEffect(() => {
        console.log("SummaryPage re-rendered.");
        console.log("Today's date string being used in SummaryPage:", todayString);
        console.log("Raw Itineraries data in SummaryPage:", itineraries);
        console.log("Raw Expenses data in SummaryPage:", expenses);
        console.log("Details data in SummaryPage:", details); // Added for debugging bookings
        console.log("All bookings:", details.bookings); // Added for debugging bookings
        console.log("Today's bookings after filter:", todayBookings); // Added for debugging bookings
        console.log("Calculated totalSpent:", totalSpent);
        console.log("Calculated todaySpent:", todaySpent);
        console.log("Today's Itinerary activities:", todayItinerary);
    }, [totalSpent, todaySpent, todayItinerary, details.bookings, itineraries, expenses, todayString, details]); // Added details to dependencies


    useEffect(() => {
        if (budgetChartInstance.current) {
            budgetChartInstance.current.destroy();
        }

        if (budgetChartRef.current) {
            const ctx = budgetChartRef.current.getContext('2d');
            budgetChartInstance.current = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['사용 금액', '남은 예산'],
                    datasets: [{
                        data: [totalSpent, Math.max(0, remainingBudget)],
                        backgroundColor: ['#f43f5e', '#0d9488'], // Red for spent, Teal for remaining
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Pretendard',
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatKRW(context.parsed) + '원';
                                    }
                                    return label;
                                }
                            },
                             titleFont: {
                                family: 'Pretendard',
                            },
                            bodyFont: {
                                family: 'Pretendard',
                            }
                        }
                    }
                }
            });
        }

        return () => {
            if (budgetChartInstance.current) {
                budgetChartInstance.current.destroy();
            }
        };
    }, [totalSpent, remainingBudget, details.expectedBudget]);

    const handleDetailSave = async (field, newValue) => {
        if (!userId) {
            console.error("User not authenticated.");
            return;
        }
        const updatedDetails = { ...details, [field]: newValue };
        setDetails(updatedDetails); // Optimistic update
        try {
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/details`, 'myDetails'), updatedDetails, { merge: true });
        } catch (e) {
            console.error("Error updating detail:", e);
            // Revert on error if optimistic update was used
            setDetails(details);
        }
    };

    return (
        <div className="p-4 md:p-6 bg-slate-50 min-h-screen">
            <h2 className="text-2xl md:text-3xl font-bold text-teal-700 mb-6 text-center">여행 개요</h2>
            {/* Removed User ID */}

            {/* 여행 개요 카드 */}
            <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div className="bg-teal-50 p-4 rounded-lg">
                        <p className="text-sm text-slate-500">여행지</p>
                        <EditableText
                            value={details.destination}
                            onSave={(val) => handleDetailSave('destination', val)}
                            className="text-xl font-semibold"
                            placeholder="여행지"
                        />
                    </div>
                    <div className="bg-teal-50 p-4 rounded-lg">
                        <p className="text-sm text-slate-500">여행 기간</p>
                        <p className="text-xl font-semibold">
                            <EditableDate
                                value={details.startDate}
                                onSave={(val) => handleDetailSave('startDate', val)}
                                className="inline-block"
                            /> ~
                            <EditableDate
                                value={details.endDate}
                                onSave={(val) => handleDetailSave('endDate', val)}
                                className="inline-block ml-1"
                            />
                        </p>
                    </div>
                    <div className="bg-teal-50 p-4 rounded-lg">
                        <p className="text-sm text-slate-500">D-Day</p>
                        <p className="text-xl font-semibold">{calculateDDay(details.startDate)}</p>
                    </div>
                </div>
                <div className="mt-4 text-center">
                    <p className="text-sm text-slate-500">여행 테마</p>
                    <EditableText
                        value={details.theme}
                        onSave={(val) => handleDetailSave('theme', val)}
                        className="text-lg font-semibold"
                        placeholder="여행 테마"
                    />
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* 예산 현황 */}
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-2xl font-bold text-teal-700 mb-4">예산 현황</h2>
                    <div className="chart-container relative w-full h-64 md:h-72 mx-auto max-w-sm">
                        <canvas ref={budgetChartRef}></canvas>
                    </div>
                    <div className="mt-4 text-center">
                        <p className="text-slate-600">총 예상 경비:
                            <EditableNumber
                                value={details.expectedBudget}
                                onSave={(val) => handleDetailSave('expectedBudget', val)}
                                className="font-bold inline-block ml-1"
                                placeholder="0"
                            />원
                        </p>
                        <p className="text-slate-600">총 실제 지출: <span className="font-bold text-red-500">{formatKRW(totalSpent)}원</span></p>
                        <p className="text-slate-600">오늘의 지출: <span className="font-bold text-blue-500">{formatKRW(todaySpent)}원</span></p>
                        <p className="text-slate-600">남은 예산: <span className="font-bold text-teal-600">{formatKRW(remainingBudget)}원</span></p>
                    </div>
                </div>

                {/* 오늘의 일정 */}
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h2 className="text-2xl font-bold text-teal-700 mb-4">오늘의 일정</h2>
                    <div className="space-y-3">
                        {todayItinerary.length > 0 ? (
                            todayItinerary.sort((a, b) => a.time.localeCompare(b.time)).map((activity) => (
                                <div key={activity.id} className="flex items-start">
                                    <div className="w-16 font-bold text-teal-600">{activity.time}</div>
                                    <div className="flex-1">
                                        <p className="font-semibold">{activity.description}</p>
                                        <p className="text-sm text-slate-500">{activity.place}</p>
                                    </div>
                                </div>
                            ))
                        ) : (
                            <p className="text-slate-500">오늘 예정된 일정이 없습니다.</p>
                        )}
                    </div>
                </div>
            </div>

            {/* 오늘의 주요 예약 */}
            <div className="bg-white p-6 rounded-lg shadow-md mt-6">
                <h2 className="text-2xl font-bold text-teal-700 mb-4">오늘의 주요 예약</h2>
                <div className="flex overflow-x-auto space-x-4 pb-4">
                    {sortedBookingTypes.length > 0 ? (
                        sortedBookingTypes.map(type => (
                            <div key={type} className="flex-shrink-0 w-72"> {/* Each type column, increased width */}
                                <h4 className="font-bold text-slate-700 mb-2">{type}</h4>
                                <div className="space-y-2"> {/* Vertical arrangement for bookings of same type */}
                                    {groupedTodayBookings[type].map(booking => (
                                        <div key={booking.id} className="border-l-2 border-blue-400 pl-4 py-2 bg-slate-50 rounded-lg shadow-sm">
                                            <p className="font-semibold">{booking.name}</p>
                                            {booking.checkin && booking.checkout && (
                                                <p className="text-sm text-slate-500">기간: {booking.checkin} ~ {booking.checkout}</p>
                                            )}
                                            {(booking.type === '항공' || booking.type === '열차' || booking.type === '버스') && booking.boardingDate && (
                                                <p className="text-sm text-slate-500">탑승일: {booking.boardingDate}</p>
                                            )}
                                            {booking.departure && booking.arrival && (
                                                <p className="text-sm text-slate-500">시간: {booking.departure} - {booking.arrival}</p>
                                            )}
                                            {booking.date && booking.startTime && booking.endTime && booking.type === "투어" && (
                                                <p className="text-sm text-slate-500">투어: {booking.date} {booking.startTime} - {booking.endTime} @ {booking.meetingPoint}</p>
                                            )}
                                            {(booking.type === '식사' || booking.type === '기타') && booking.date && booking.time && (
                                                <p className="text-sm text-slate-500">날짜: {booking.date} / 시간: {booking.time}</p>
                                            )}
                                            <p className="text-sm text-slate-500">예약번호: {booking.ref}</p>
                                            {booking.notes && <p className="text-xs text-slate-400">메모: {booking.notes}</p>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))
                    ) : (
                        <p className="text-slate-500 w-full text-center py-4">오늘 해당하는 주요 예약이 없습니다.</p>
                    )}
                </div>
            </div>
        </div>
    );
};

// New component for AI suggestions
const AISuggestionModal = ({ isOpen, onClose, suggestions, onAddSelected }) => {
    const [selectedItems, setSelectedItems] = useState([]);

    useEffect(() => {
        if (!isOpen) {
            setSelectedItems([]); // Reset selected items when modal closes
        }
    }, [isOpen]);

    const handleCheckboxChange = (id) => {
        setSelectedItems(prev =>
            prev.includes(id) ? prev.filter(item => item !== id) : [...prev, id]
        );
    };

    const handleAddClick = () => {
        const itemsToAdd = suggestions.filter(s => selectedItems.includes(s.id));
        onAddSelected(itemsToAdd);
        onClose();
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                <h3 className="text-xl font-bold mb-4 text-teal-700">✨ AI 추천 일정</h3>
                {suggestions.length === 0 ? (
                    <p className="text-slate-500">추천 일정을 불러오는 중이거나 없습니다.</p>
                ) : (
                    <div className="space-y-3 max-h-80 overflow-y-auto pr-2">
                        {suggestions.map(s => (
                            <div key={s.id} className="flex items-start bg-slate-50 p-3 rounded-md">
                                <input
                                    type="checkbox"
                                    className="form-checkbox h-5 w-5 rounded border-slate-300 text-teal-600 focus:ring-teal-500 mt-1 mr-3"
                                    checked={selectedItems.includes(s.id)}
                                    onChange={() => handleCheckboxChange(s.id)}
                                />
                                <div className="flex-1">
                                    <p className="font-semibold text-slate-800">{s.time} - {s.place}</p>
                                    <p className="text-sm text-slate-600">{s.description}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
                <div className="flex justify-end space-x-3 mt-4">
                    <button onClick={onClose} className="bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-md hover:bg-slate-400 transition">
                        닫기
                    </button>
                    <button onClick={handleAddClick} className="bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition" disabled={selectedItems.length === 0}>
                        선택 항목 추가
                    </button>
                </div>
            </div>
        </div>
    );
};


// ItineraryPage
const ItineraryPage = () => {
    const { db, appId, userId, itineraries, setItineraries, isAuthReady, openAlert, openPrompt, openConfirm, details } = useContext(AppContext); // Added 'details'
    const [newActivityTime, setNewActivityTime] = useState('');
    const [newActivityDesc, setNewActivityDesc] = useState('');
    const [newActivityPlace, setNewActivityPlace] = useState('');
    const [openAccordion, setOpenAccordion] = useState(null); // 열려있는 아코디언 날짜 ID

    const [isLoadingAISuggestions, setIsLoadingAISuggestions] = useState(false); // New: AI suggestion loading state
    const [aiSuggestions, setAiSuggestions] = useState([]); // New: AI suggestions
    const [isAISuggestionModalOpen, setIsAISuggestionModalOpen] = useState(false); // New: AI suggestion modal state
    const [currentAISuggestionDate, setCurrentAISuggestionDate] = useState(null); // New: To track which date AI suggestions are for

    // 8월 4일부터 8월 13일까지의 날짜 생성 (기본 범위)
    const getInitialDates = () => {
        const dates = [];
        const startDate = new Date('2025-08-04');
        const endDate = new Date('2025-08-13');
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            dates.push(d.toISOString().split('T')[0]); // YYYY-MM-DD
        }
        return dates;
    };

    // Firestore에 날짜별 일정 데이터 업데이트
    const updateItineraryDay = async (date, updatedActivities) => {
        if (!isAuthReady || !userId) {
            console.error("Firebase not ready or user not authenticated.");
            openAlert("사용자 인증이 완료되지 않았습니다. 일정을 업데이트할 수 없습니다.");
            return;
        }
        const itineraryDocRef = doc(db, `artifacts/${appId}/users/${userId}/itineraries`, date);
        try {
            await setDoc(itineraryDocRef, { activities: updatedActivities }, { merge: true });
        } catch (e) {
            console.error("Error updating itinerary day: ", e);
            openAlert("일정 업데이트 중 오류가 발생했습니다: " + e.message);
        }
    };

    const handleAddActivity = async (date) => {
        if (newActivityTime && newActivityDesc && newActivityPlace) {
            const currentActivities = itineraries[date]?.activities || [];
            const updatedActivities = [...currentActivities, {
                id: crypto.randomUUID(),
                time: newActivityTime,
                description: newActivityDesc,
                place: newActivityPlace,
                transport: "도보", // 기본값
                notes: "" // 기본값
            }];
            await updateItineraryDay(date, updatedActivities);
            setNewActivityTime('');
            setNewActivityDesc('');
            setNewActivityPlace('');
            // 새로 추가된 활동이 보이도록 아코디언 펼치기
            setOpenAccordion(date);
        } else {
            openAlert("시간, 장소, 활동 내용을 모두 입력해야 합니다.");
        }
    };

    const handleUpdateActivity = async (date, activityId, field, newValue) => {
        const currentActivities = itineraries[date]?.activities || [];
        const updatedActivities = currentActivities.map(activity =>
            activity.id === activityId ? { ...activity, [field]: newValue } : activity
        );
        await updateItineraryDay(date, updatedActivities);
    };

    const handleDeleteActivity = async (date, activityId) => {
        openConfirm("이 활동을 삭제하시겠습니까?", "활동 삭제", async (confirmed) => {
            if (confirmed) {
                const currentActivities = itineraries[date]?.activities || [];
                const updatedActivities = currentActivities.filter(activity => activity.id !== activityId);
                await updateItineraryDay(date, updatedActivities);
            }
        });
    };

    const handleAddDay = async () => {
        const newDate = await openPrompt("새로운 날짜를 입력하세요 (YYYY-MM-DD):", "날짜 추가", "YYYY-MM-DD", '', 'date'); // inputType 'date'
        if (newDate) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
                openAlert("날짜 형식이 올바르지 않습니다. YYYY-MM-DD 형식으로 입력해주세요.");
                return;
            }
            if (itineraries[newDate] && itineraries[newDate].activities && itineraries[newDate].activities.length > 0) {
                openAlert("이미 해당 날짜에 일정이 존재합니다.");
                return;
            }
            await updateItineraryDay(newDate, []); // 빈 활동 목록으로 새 날짜 문서 생성
            setOpenAccordion(newDate); // 새로 추가된 날짜 아코디언 열기
        }
    };

    const handleDeleteDay = async (date) => {
        if (!isAuthReady || !userId) {
            console.error("Firebase not ready or user not authenticated.");
            openAlert("사용자 인증이 완료되지 않았습니다. 날짜를 삭제할 수 없습니다.");
            return;
        }
        openConfirm(`날짜 ${date}의 모든 일정을 삭제하시겠습니까?`, "날짜 삭제", async (confirmed) => {
            if (confirmed) {
                const itineraryDocRef = doc(db, `artifacts/${appId}/users/${userId}/itineraries`, date);
                try {
                    await deleteDoc(itineraryDocRef); // 실제 문서 삭제
                } catch (e) {
                    console.error("Error deleting day: ", e);
                    openAlert("날짜 삭제 중 오류가 발생했습니다: " + e.message);
                }
            }
        });
    };

    const toggleAccordion = (date) => {
        setOpenAccordion(openAccordion === date ? null : date);
    };

    // AI 추천 기능 추가
    const handleAISuggestion = async (date) => {
        setIsLoadingAISuggestions(true);
        setAiSuggestions([]); // Clear previous suggestions
        setCurrentAISuggestionDate(date); // Set the date for which suggestions are being fetched

        try {
            const destination = details.destination;
            const currentActivities = itineraries[date]?.activities || [];
            const currentActivitiesText = currentActivities.length > 0
                ? currentActivities.map(act => `${act.time} ${act.place}: ${act.description}`).join(', ')
                : '아직 일정이 없습니다.';

            const prompt = `여행지: ${destination}, 날짜: ${date}, 현재 일정: ${currentActivitiesText}. 이 날짜에 추가할 만한 활동, 식사 장소, 또는 현지 팁을 3-5가지 추천해 주세요. 각 추천은 '시간', '장소', '내용' 필드를 가진 JSON 배열 형태로 제공하고, 시간은 HH:MM 형식으로, 장소와 내용은 구체적으로 작성해주세요.`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "time": { "type": "STRING" },
                                "place": { "type": "STRING" },
                                "description": { "type": "STRING" }
                            },
                            "propertyOrdering": ["time", "place", "description"]
                        }
                    }
                }
            };

            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const jsonString = result.candidates[0].content.parts[0].text;
                try {
                    const parsedSuggestions = JSON.parse(jsonString);
                    setAiSuggestions(parsedSuggestions.map(s => ({ ...s, id: crypto.randomUUID() })));
                    setIsAISuggestionModalOpen(true);
                } catch (parseError) {
                    console.error("Failed to parse AI suggestions JSON:", parseError);
                    openAlert("AI 추천을 파싱하는 데 실패했습니다. 다시 시도해주세요.");
                }
            } else {
                openAlert("AI 추천을 생성하지 못했습니다. 다시 시도해주세요.");
            }
        } catch (error) {
            console.error("Error fetching AI suggestions:", error);
            openAlert("AI 추천을 가져오는 중 오류가 발생했습니다: " + error.message);
        } finally {
            setIsLoadingAISuggestions(false);
        }
    };

    const handleAddSelectedAISuggestions = async (selectedSuggestions) => {
        if (!currentAISuggestionDate) return; // Ensure a date is selected

        const currentActivities = itineraries[currentAISuggestionDate]?.activities || [];
        const newActivities = selectedSuggestions.map(s => ({
            id: crypto.randomUUID(),
            time: s.time,
            description: s.description,
            place: s.place,
            transport: "AI 추천", // Default transport for AI suggestions
            notes: "AI 추천" // Default notes for AI suggestions
        }));
        const updatedActivities = [...currentActivities, ...newActivities];
        await updateItineraryDay(currentAISuggestionDate, updatedActivities);
        setIsAISuggestionModalOpen(false);
        setAiSuggestions([]); // Clear suggestions after adding
        setCurrentAISuggestionDate(null); // Reset current suggestion date
    };


    // 모든 날짜 (기본 범위 + Firestore에 있는 날짜)를 가져와 정렬
    const allDates = [...new Set([...getInitialDates(), ...Object.keys(itineraries)])];
    const sortedDates = allDates.sort((a, b) => new Date(a) - new Date(b));

    return (
        <div className="p-4 md:p-6 bg-slate-50 min-h-screen">
            <h2 className="text-2xl md:text-3xl font-bold text-teal-700 mb-4 text-center">상세 여행 일정</h2>
            <p className="text-slate-600 mb-6 text-center">각 날짜를 클릭하여 상세 일정을 펼치거나 접을 수 있습니다. 항목을 더블클릭하여 수정하고, 버튼을 통해 추가/삭제할 수 있습니다.</p>

            <button
                onClick={handleAddDay}
                className="bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition mb-4"
            >
                <i className="fa-solid fa-calendar-plus mr-2"></i>새로운 날짜 추가
            </button>

            <div className="space-y-2">
                {sortedDates.map(date => {
                    const dayOfWeek = new Date(date).toLocaleDateString('ko-KR', { weekday: 'short' });
                    const dayActivities = itineraries[date]?.activities || [];

                    return (
                        <div key={date} className="bg-white rounded-lg shadow-md">
                            {/* Outer div for accordion toggle, replacing button to fix nesting */}
                            <div
                                className="w-full flex justify-between items-center p-4 text-left font-semibold text-slate-800 hover:bg-slate-50 rounded-t-lg cursor-pointer"
                                onClick={() => toggleAccordion(date)}
                            >
                                <span className="flex-1">
                                    {date} ({dayOfWeek})
                                </span>
                                <div className="flex items-center">
                                    {isLoadingAISuggestions && currentAISuggestionDate === date && (
                                        <span className="text-teal-600 text-sm mr-2">AI 추천 생성 중...</span>
                                    )}
                                    <button
                                        onClick={(e) => { e.stopPropagation(); handleAISuggestion(date); }}
                                        className="bg-purple-500 text-white text-sm py-1 px-3 rounded-md hover:bg-purple-600 transition mr-2"
                                        disabled={isLoadingAISuggestions}
                                    >
                                        ✨ AI 추천
                                    </button>
                                    <button
                                        onClick={(e) => { e.stopPropagation(); handleDeleteDay(date); }}
                                        className="text-red-500 hover:text-red-700 mr-2"
                                    >
                                        <i className="fa-solid fa-trash"></i>
                                    </button>
                                    <i className={`fa-solid fa-chevron-down transition-transform ${openAccordion === date ? 'rotate-180' : ''}`}></i>
                                </div>
                            </div>
                            <div
                                className="accordion-content overflow-hidden transition-all duration-300 ease-out"
                                style={{ maxHeight: openAccordion === date ? '1000px' : '0px' }} // MaxHeight를 충분히 크게 설정
                            >
                                <div className="p-4 border-t border-slate-200">
                                    {dayActivities.length > 0 ? (
                                        dayActivities.sort((a, b) => a.time.localeCompare(b.time)).map((activity) => (
                                            <div key={activity.id} className="flex items-start border-l-2 border-teal-200 pl-4 py-2 ml-3 relative group">
                                                <div className="w-20 font-bold text-teal-600">
                                                    <EditableText
                                                        value={activity.time}
                                                        onSave={(val) => handleUpdateActivity(date, activity.id, 'time', val)}
                                                        className="inline-block"
                                                        placeholder="시간"
                                                    />
                                                </div>
                                                <div className="flex-1">
                                                    <p className="font-semibold">
                                                        <EditableText
                                                            value={activity.place}
                                                            onSave={(val) => handleUpdateActivity(date, activity.id, 'place', val)}
                                                            className="inline-block"
                                                            placeholder="장소"
                                                        />
                                                    </p>
                                                    <p className="text-sm text-slate-600">
                                                        <EditableText
                                                            value={activity.description}
                                                            onSave={(val) => handleUpdateActivity(date, activity.id, 'description', val)}
                                                            className="inline-block"
                                                            placeholder="활동 내용"
                                                        />
                                                    </p>
                                                    <p className="text-xs text-slate-400 mt-1">이동:
                                                        <EditableText
                                                            value={activity.transport}
                                                            onSave={(val) => handleUpdateActivity(date, activity.id, 'transport', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="이동 수단"
                                                        /> | 메모:
                                                        <EditableText
                                                            value={activity.notes}
                                                            onSave={(val) => handleUpdateActivity(date, activity.id, 'notes', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="메모"
                                                        />
                                                    </p>
                                                </div>
                                                <button
                                                    onClick={() => handleDeleteActivity(date, activity.id)}
                                                    className="delete-event-btn absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                                >
                                                    <i className="fa-solid fa-xmark"></i>
                                                </button>
                                            </div>
                                        ))
                                    ) : (
                                        <p className="text-slate-500 text-center py-4">이 날짜에는 아직 활동이 없습니다. 아래 버튼을 눌러 추가해주세요.</p>
                                    )}
                                    <div className="mt-4 border-t border-slate-200 pt-4">
                                        <h4 className="text-md font-semibold mb-2">새 활동 추가</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                                            <input
                                                type="time"
                                                className="p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                                placeholder="시간 (예: 10:00)"
                                                value={newActivityTime}
                                                onChange={(e) => setNewActivityTime(e.target.value)}
                                            />
                                            <input
                                                type="text"
                                                className="p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                                placeholder="장소"
                                                value={newActivityPlace}
                                                onChange={(e) => setNewActivityPlace(e.target.value)}
                                            />
                                            <input
                                                type="text"
                                                className="p-2 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                                                placeholder="활동 내용"
                                                value={newActivityDesc}
                                                onChange={(e) => setNewActivityDesc(e.target.value)}
                                            />
                                        </div>
                                        <button
                                            onClick={() => handleAddActivity(date)}
                                            className="w-full bg-teal-400 text-white text-sm py-2 px-3 rounded-md hover:bg-teal-500 transition font-semibold"
                                        >
                                            <i className="fa-solid fa-plus mr-1"></i>활동 추가
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
            <AISuggestionModal
                isOpen={isAISuggestionModalOpen}
                onClose={() => setIsAISuggestionModalOpen(false)}
                suggestions={aiSuggestions}
                onAddSelected={handleAddSelectedAISuggestions}
            />
        </div>
    );
};

// ExpensePage
const ExpensePage = () => {
    const { db, appId, userId, expenses, isAuthReady, openAlert, openConfirm } = useContext(AppContext);
    const expensesChartRef = useRef(null);
    const expensesChartInstance = useRef(null);

    const [selectedDate, setSelectedDate] = useState('');
    const [newExpenseDesc, setNewExpenseDesc] = useState('');
    const [newExpenseAmount, setNewExpenseAmount] = useState('');
    const [newExpenseCurrency, setNewExpenseCurrency] = useState('KRW'); // KRW, EUR, CZK, USD
    const [newExpenseCategory, setNewExpenseCategory] = useState('식비');
    const [openAccordion, setOpenAccordion] = useState(null); // 날짜별 아코디언

    // 8월 4일부터 8월 13일까지의 날짜 생성 (기본 범위)
    const getInitialDates = () => {
        const dates = [];
        const startDate = new Date('2025-08-04');
        const endDate = new Date('2025-08-13');
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            dates.push(d.toISOString().split('T')[0]); // YYYY-MM-DD
        }
        return dates;
    };

    // Firestore에 날짜별 경비 데이터 업데이트
    const updateExpenseDay = async (date, updatedItems) => {
        if (!isAuthReady || !userId) {
            console.error("Firebase not ready or user not authenticated.");
            openAlert("사용자 인증이 완료되지 않았습니다. 경비를 업데이트할 수 없습니다.");
            return;
        }
        const expenseDocRef = doc(db, `artifacts/${appId}/users/${userId}/expenses`, date);
        try {
            await setDoc(expenseDocRef, { items: updatedItems }, { merge: true });
        } catch (e) {
            console.error("Error updating expense day: ", e);
            openAlert("경비 업데이트 중 오류가 발생했습니다: " + e.message);
        }
    };

    const handleAddExpense = async (e) => {
        e.preventDefault();
        if (selectedDate && newExpenseDesc && newExpenseAmount && !isNaN(parseFloat(newExpenseAmount))) {
            const amountInKRW = convertToKRW(parseFloat(newExpenseAmount), newExpenseCurrency);
            const currentItems = expenses[selectedDate]?.items || [];
            const updatedItems = [...currentItems, {
                id: crypto.randomUUID(),
                description: newExpenseDesc,
                amount: amountInKRW, // Always store in KRW
                originalAmount: parseFloat(newExpenseAmount),
                originalCurrency: newExpenseCurrency,
                category: newExpenseCategory
            }];
            await updateExpenseDay(selectedDate, updatedItems);
            setNewExpenseDesc('');
            setNewExpenseAmount('');
            setNewExpenseCurrency('KRW');
            setNewExpenseCategory('식비');
            setSelectedDate('');
            setOpenAccordion(selectedDate); // 새로 추가된 항목이 보이도록 아코디언 열기
        } else {
            openAlert("모든 경비 정보를 올바르게 입력해주세요.");
        }
    };

    const handleUpdateExpense = async (date, expenseId, field, newValue) => {
        const currentItems = expenses[date]?.items || [];
        const updatedItems = currentItems.map(item => {
            if (item.id === expenseId) {
                if (field === 'amount') { // 금액 수정 시 원화로 변환
                    return { ...item, amount: convertToKRW(parseFloat(newValue), item.originalCurrency), originalAmount: parseFloat(newValue) };
                } else if (field === 'originalCurrency') { // 통화 변경 시 원화 재계산
                    return { ...item, originalCurrency: newValue, amount: convertToKRW(item.originalAmount, newValue) };
                }
                return { ...item, [field]: newValue };
            }
            return item;
        });
        await updateExpenseDay(date, updatedItems);
    };

    const handleDeleteExpense = async (date, expenseId) => {
        openConfirm("이 지출 내역을 삭제하시겠습니까?", "지출 삭제", async (confirmed) => {
            if (confirmed) {
                const currentItems = expenses[date]?.items || [];
                const updatedItems = currentItems.filter(item => item.id !== expenseId);
                await updateExpenseDay(date, updatedItems);
            }
        });
    };

    const calculateOverallTotal = () => {
        return Object.values(expenses).reduce((sum, day) =>
            sum + day.items.reduce((daySum, item) => daySum + (item.amount || 0), 0), 0
        );
    };

    const calculateDailyTotal = (date) => {
        const dailyExpenses = expenses[date]?.items || [];
        return dailyExpenses.reduce((sum, item) => sum + (item.amount || 0), 0);
    };

    useEffect(() => {
        if (expensesChartInstance.current) {
            expensesChartInstance.current.destroy();
        }

        if (expensesChartRef.current) {
            const ctx = expensesChartRef.current.getContext('2d');
            const today = new Date();
            // Get local date components
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-indexed
            const day = today.getDate().toString().padStart(2, '0');
            const todayString = `${year}-${month}-${day}`; // YYYY-MM-DD 형식

            // 차트에 표시할 데이터: openAccordion이 있으면 해당 날짜, 없으면 오늘 날짜
            const dataToChart = (openAccordion && expenses[openAccordion]) ? expenses[openAccordion].items : (expenses[todayString]?.items || []);

            const expenseByCategory = dataToChart.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                return acc;
            }, {});

            const labels = Object.keys(expenseByCategory);
            const data = Object.values(expenseByCategory);
            const backgroundColors = ['#14b8a6', '#0891b2', '#6366f1', '#a855f7', '#ec4899', '#f97316'];

            expensesChartInstance.current = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    family: 'Pretendard',
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatKRW(context.parsed) + '원';
                                    }
                                    return label;
                                }
                            },
                            titleFont: {
                                family: 'Pretendard',
                            },
                            bodyFont: {
                                family: 'Pretendard',
                            }
                        }
                    }
                }
            });
        }

        return () => {
            if (expensesChartInstance.current) {
                expensesChartInstance.current.destroy();
            }
        };
    }, [expenses, openAccordion]); // openAccordion을 의존성 배열에 추가

    // 모든 날짜 (기본 범위 + Firestore에 있는 날짜)를 가져와 정렬
    const allDates = [...new Set([...getInitialDates(), ...Object.keys(expenses)])];
    const sortedDates = allDates.sort((a, b) => new Date(a) - new Date(b));

    return (
        <div className="p-4 md:p-6 bg-slate-50 min-h-screen">
            <h2 className="text-2xl md:text-3xl font-bold text-teal-700 mb-4 text-center">경비 관리</h2>
            <p className="text-slate-600 mb-6 text-center">이곳에서 여행 경비를 관리하세요. 카테고리별 지출 내역을 차트로 확인하고, 새로운 지출을 추가하고 수정/삭제할 수 있습니다.</p>

            <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 className="text-xl font-semibold mb-2">지출 내역 추가</h3>
                        <form onSubmit={handleAddExpense} className="space-y-4">
                            <input
                                type="date"
                                className="w-full p-2 border rounded-md focus:ring-teal-500 focus:border-teal-500"
                                value={selectedDate}
                                onChange={(e) => setSelectedDate(e.target.value)}
                                required
                            />
                            <select
                                className="w-full p-2 border rounded-md focus:ring-teal-500 focus:border-teal-500"
                                value={newExpenseCategory}
                                onChange={(e) => setNewExpenseCategory(e.target.value)}
                                required
                            >
                                <option value="식비">식비</option>
                                <option value="교통">교통</option>
                                <option value="숙박">숙박</option>
                                <option value="관광">관광</option>
                                <option value="쇼핑">쇼핑</option>
                                <option value="기타">기타</option>
                            </select>
                            <input
                                type="text"
                                placeholder="상세 내역"
                                className="w-full p-2 border rounded-md focus:ring-teal-500 focus:border-teal-500"
                                value={newExpenseDesc}
                                onChange={(e) => setNewExpenseDesc(e.target.value)}
                                required
                            />
                            <div className="flex items-center space-x-2">
                                <input
                                    type="number"
                                    placeholder="금액"
                                    className="flex-1 p-2 border rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={newExpenseAmount}
                                    onChange={(e) => setNewExpenseAmount(e.target.value)}
                                    required
                                />
                                <select
                                    className="p-2 border rounded-md focus:ring-teal-500 focus:border-teal-500"
                                    value={newExpenseCurrency}
                                    onChange={(e) => setNewExpenseCurrency(e.target.value)}
                                >
                                    <option value="KRW">원</option>
                                    <option value="EUR">유로</option>
                                    <option value="CZK">코루나</option>
                                    <option value="USD">달러</option>
                                </select>
                                {newExpenseAmount && newExpenseCurrency !== 'KRW' && (
                                    <span className="text-sm text-slate-600">
                                        ({formatKRW(convertToKRW(parseFloat(newExpenseAmount), newExpenseCurrency))}원)
                                    </span>
                                )}
                            </div>
                            <button type="submit" className="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition">추가하기</button>
                        </form>
                    </div>
                    <div className="chart-container relative w-full h-64 md:h-72 mx-auto max-w-sm">
                        <canvas ref={expensesChartRef}></canvas>
                    </div>
                </div>
            </div>

            <div className="bg-white p-6 rounded-lg shadow-md">
                <h3 className="text-xl font-semibold mb-4">지출 상세 내역</h3>
                <div className="space-y-2">
                    {sortedDates.map(date => {
                        const dailyExpenses = expenses[date]?.items || [];
                        const dailyTotal = calculateDailyTotal(date);
                        return (
                            <div key={date} className="bg-slate-50 rounded-lg">
                                <button
                                    className="w-full flex justify-between items-center p-4 text-left font-semibold text-slate-800 hover:bg-slate-100 rounded-t-lg"
                                    onClick={() => setOpenAccordion(openAccordion === date ? null : date)}
                                >
                                    <span>{date}</span>
                                    <span>총: {formatKRW(dailyTotal)}원 <i className={`fa-solid fa-chevron-down transition-transform ${openAccordion === date ? 'rotate-180' : ''}`}></i></span>
                                </button>
                                <div
                                    className="accordion-content overflow-hidden transition-all duration-300 ease-out"
                                    style={{ maxHeight: openAccordion === date ? '1000px' : '0px' }}
                                >
                                    <div className="p-4 border-t border-slate-200">
                                        {dailyExpenses.length > 0 ? (
                                            <div className="overflow-x-auto"> {/* Added for horizontal scrolling on small screens */}
                                                <table className="min-w-full text-left">
                                                    <thead className="bg-slate-100">
                                                        <tr>
                                                            <th className="p-2 whitespace-nowrap">카테고리</th>
                                                            <th className="p-2 whitespace-nowrap">내역</th>
                                                            <th className="p-2 text-right whitespace-nowrap">금액</th>
                                                            <th className="p-2"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {dailyExpenses.map(expense => (
                                                            <tr key={expense.id} className="border-b">
                                                                <td className="p-2 whitespace-nowrap">
                                                                    <select
                                                                        className="bg-slate-200 text-slate-700 px-2 py-1 text-xs rounded-full focus:outline-none focus:ring-2 focus:ring-teal-500"
                                                                        value={expense.category}
                                                                        onChange={(e) => handleUpdateExpense(date, expense.id, 'category', e.target.value)}
                                                                    >
                                                                        <option value="식비">식비</option>
                                                                        <option value="교통">교통</option>
                                                                        <option value="숙박">숙박</option>
                                                                        <option value="관광">관광</option>
                                                                        <option value="쇼핑">쇼핑</option>
                                                                        <option value="기타">기타</option>
                                                                    </select>
                                                                </td>
                                                                <td className="p-2 whitespace-nowrap">
                                                                    <EditableText
                                                                        value={expense.description}
                                                                        onSave={(val) => handleUpdateExpense(date, expense.id, 'description', val)}
                                                                        className="inline-block"
                                                                        placeholder="내역"
                                                                    />
                                                                </td>
                                                                <td className="p-2 text-right whitespace-nowrap">
                                                                    <EditableNumber
                                                                        value={expense.originalAmount} // 원본 금액 표시
                                                                        onSave={(val) => handleUpdateExpense(date, expense.id, 'amount', val)}
                                                                        className="inline-block"
                                                                        placeholder="0"
                                                                    />
                                                                    <select
                                                                        className="p-2 border rounded-md focus:ring-teal-500 focus:border-teal-500"
                                                                        value={expense.originalCurrency}
                                                                        onChange={(e) => handleUpdateExpense(date, expense.id, 'originalCurrency', e.target.value)}
                                                                    >
                                                                        <option value="KRW">원</option>
                                                                        <option value="EUR">유로</option>
                                                                        <option value="CZK">코루나</option>
                                                                        <option value="USD">달러</option>
                                                                    </select>
                                                                    {expense.originalCurrency !== 'KRW' && (
                                                                        <span className="text-xs text-slate-500 ml-1">
                                                                            ({formatKRW(expense.amount)}원)
                                                                        </span>
                                                                    )}
                                                                </td>
                                                                <td className="p-2 text-center">
                                                                    <button
                                                                        onClick={() => handleDeleteExpense(date, expense.id)}
                                                                        className="text-red-500 hover:text-red-700"
                                                                    >
                                                                        <i className="fa-solid fa-xmark"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ) : (
                                            <p className="text-slate-500 text-center py-4">이 날짜에 지출된 경비가 없습니다.</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
                <div className="mt-6 text-right text-xl font-bold text-teal-700">
                    총 지출: {formatKRW(calculateOverallTotal())}원
                </div>
            </div>
        </div>
    );
};

// ChecklistPage
const ChecklistPage = () => {
    const { db, appId, userId, checklist, setChecklist, isAuthReady, openAlert, openConfirm, openPrompt } = useContext(AppContext);
    const [newItemName, setNewItemName] = useState('');
    const [newItemCategory, setNewItemCategory] = useState('');
    const [openCategory, setOpenCategory] = useState(null);

    // Ensure categories are always sorted for stable display
    const categories = Object.keys(checklist).sort(); // Sort categories alphabetically

    // Firestore에 체크리스트 데이터 업데이트
    const updateChecklist = async (updatedList) => {
        if (!isAuthReady || !userId) {
            console.error("Firebase not ready or user not authenticated.");
            openAlert("사용자 인증이 완료되지 않았습니다. 체크리스트를 업데이트할 수 없습니다.");
            return;
        }
        try {
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/checklists`, 'myChecklist'), updatedList, { merge: true });
        } catch (e) {
            console.error("Error updating checklist: ", e);
            openAlert("체크리스트 업데이트 중 오류가 발생했습니다: " + e.message);
        }
    };

    const handleToggleCheck = async (category, itemId) => {
        const updatedList = { ...checklist };
        updatedList[category] = updatedList[category].map(item =>
            item.id === itemId ? { ...item, checked: !item.checked } : item
        );
        await updateChecklist(updatedList);
    };

    const handleAddItem = async (category) => {
        if (newItemName && category) { // 카테고리도 선택되어야 함
            const updatedList = { ...checklist };
            if (!updatedList[category]) {
                updatedList[category] = []; // 새 카테고리인 경우 배열 초기화
            }
            updatedList[category].push({ id: crypto.randomUUID(), item: newItemName, checked: false, notes: "" });
            await updateChecklist(updatedList);
            setNewItemName('');
            setNewItemCategory(category); // 추가 후에도 카테고리 선택 유지
            setOpenCategory(category); // 새로 추가된 항목이 보이도록 아코디언 열기
        } else {
            openAlert("항목 이름과 카테고리를 모두 입력해주세요.");
        }
    };

    const handleDeleteItem = async (category, itemId) => {
        openConfirm("이 준비물 항목을 삭제하시겠습니까?", "항목 삭제", async (confirmed) => {
            if (confirmed) {
                const updatedList = { ...checklist };
                updatedList[category] = updatedList[category].filter(item => item.id !== itemId);
                await updateChecklist(updatedList);
            }
        });
    };

    const handleUpdateItem = async (category, itemId, field, newValue) => {
        const updatedList = { ...checklist };
        updatedList[category] = updatedList[category].map(item =>
            item.id === itemId ? { ...item, [field]: newValue } : item
        );
        await updateChecklist(updatedList);
    };

    const handleAddCategory = async () => {
        const newCategoryName = await openPrompt("새로운 카테고리 이름을 입력하세요:", "카테고리 추가");
        if (newCategoryName) {
            if (checklist[newCategoryName]) {
                openAlert("이미 존재하는 카테고리 이름입니다.");
                return;
            }
            const updatedList = { ...checklist, [newCategoryName]: [] };
            await updateChecklist(updatedList);
            setOpenCategory(newCategoryName); // 새로 추가된 카테고리 아코디언 열기
        }
    };

    const handleDeleteCategory = async (categoryToDelete) => {
        openConfirm(`카테고리 '${categoryToDelete}'와 모든 항목을 삭제하시겠습니까?`, "카테고리 삭제", async (confirmed) => {
            if (confirmed) {
                const updatedList = { ...checklist };
                delete updatedList[categoryToDelete];
                await updateChecklist(updatedList);
            }
        });
    };

    const handleUpdateCategoryName = async (oldCategoryName, newCategoryName) => {
        if (oldCategoryName === newCategoryName) return;
        if (checklist[newCategoryName]) {
            openAlert("이미 존재하는 카테고리 이름입니다.");
            return;
        }
        const updatedList = { ...checklist };
        updatedList[newCategoryName] = updatedList[oldCategoryName];
        delete updatedList[oldCategoryName];
        await updateChecklist(updatedList);
        setOpenCategory(newCategoryName); // 이름 변경 후 해당 카테고리 열기
    };

    const totalItems = Object.values(checklist).flat().length;
    const checkedItems = Object.values(checklist).flat().filter(item => item.checked).length;
    const progress = totalItems > 0 ? (checkedItems / totalItems) * 100 : 0;

    return (
        <div className="p-4 md:p-6 bg-slate-50 min-h-screen">
            <h2 className="text-2xl md:text-3xl font-bold text-teal-700 mb-4 text-center">준비물 체크리스트</h2>
            <p className="text-slate-600 mb-6 text-center">여행에 필요한 모든 것을 잊지 않도록 체크리스트를 활용하세요. 항목을 더블클릭하여 내용을 수정하고, 버튼을 통해 추가/삭제할 수 있습니다.</p>

            <div className="w-full bg-slate-200 rounded-full h-2.5 mb-4">
                <div className="bg-teal-500 h-2.5 rounded-full transition-all duration-500 ease-in-out" style={{ width: `${progress}%` }}></div>
            </div>

            <button
                onClick={handleAddCategory}
                className="bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition mb-4"
            >
                <i className="fa-solid fa-folder-plus mr-2"></i>새 카테고리 추가
            </button>

            <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 className="text-xl font-semibold mb-2">새 항목 추가</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input
                        type="text"
                        className="p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                        placeholder="항목 이름"
                        value={newItemName}
                        onChange={(e) => setNewItemName(e.target.value)}
                    />
                    <select
                        className="p-3 border border-slate-300 rounded-md focus:ring-teal-500 focus:border-teal-500"
                        value={newItemCategory}
                        onChange={(e) => setNewItemCategory(e.target.value)}
                    >
                        <option value="">카테고리 선택</option>
                        {categories.map(cat => (
                            <option key={cat} value={cat}>{cat}</option>
                        ))}
                    </select>
                </div>
                <button
                    onClick={() => handleAddItem(newItemCategory)}
                    className="w-full bg-teal-600 text-white py-3 rounded-md hover:bg-teal-700 transition duration-200 ease-in-out font-semibold"
                    disabled={!newItemCategory || !newItemName} // 카테고리나 항목 이름이 없으면 비활성화
                >
                    항목 추가
                </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"> {/* 열로 보여주기 위해 grid 사용 */}
                {categories.map(category => (
                    <div key={category} className="bg-white rounded-lg shadow-md">
                        {/* Outer div for accordion toggle, replacing button to fix nesting */}
                        <div
                            className="w-full flex justify-between items-center p-4 text-left font-semibold text-lg text-slate-800 hover:bg-slate-50 rounded-t-lg cursor-pointer"
                            onClick={() => setOpenCategory(openCategory === category ? null : category)}
                        >
                            <EditableText
                                value={category}
                                onSave={(val) => handleUpdateCategoryName(category, val)}
                                className="flex-1"
                                placeholder="카테고리 이름"
                            />
                            <span className="text-sm text-slate-500 ml-2">({checklist[category]?.length || 0}개)</span> {/* 항목 개수 표시 */}
                            <div className="flex items-center">
                                <button
                                    onClick={(e) => { e.stopPropagation(); handleDeleteCategory(category); }}
                                    className="text-red-500 hover:text-red-700 ml-2"
                                >
                                    <i className="fa-solid fa-trash"></i>
                                </button>
                                <i className={`fa-solid fa-chevron-down transition-transform ${openCategory === category ? 'rotate-180' : ''}`}></i>
                            </div>
                        </div>
                        <div
                            className="accordion-content overflow-hidden transition-all duration-300 ease-out"
                            style={{ maxHeight: openCategory === category ? '1000px' : '0px' }}
                        >
                            <div className="p-4 border-t border-slate-200">
                                <ul className="space-y-3">
                                    {checklist[category]?.map(item => (
                                        <li key={item.id} className="flex justify-between items-center bg-slate-50 p-3 rounded-md relative group">
                                            <label className="flex items-center cursor-pointer flex-1">
                                                <input
                                                    type="checkbox"
                                                    checked={item.checked}
                                                    onChange={() => handleToggleCheck(category, item.id)}
                                                    className="form-checkbox h-5 w-5 rounded border-slate-300 text-teal-600 focus:ring-teal-500"
                                                />
                                                <span className={`ml-3 block text-sm font-medium text-slate-700 flex-1 ${item.checked ? 'line-through text-slate-500' : ''}`}>
                                                    <EditableText
                                                        value={item.item}
                                                        onSave={(val) => handleUpdateItem(category, item.id, 'item', val)}
                                                        className="inline-block"
                                                        placeholder="항목"
                                                    />
                                                    {item.notes && (
                                                        <span className="block text-xs text-slate-400">
                                                            <EditableText
                                                                value={item.notes}
                                                                onSave={(val) => handleUpdateItem(category, item.id, 'notes', val)}
                                                                className="inline-block"
                                                                placeholder="메모"
                                                            />
                                                        </span>
                                                    )}
                                                </span>
                                            </label>
                                            <button
                                                onClick={() => handleDeleteItem(category, item.id)}
                                                className="delete-checklist-item-btn absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                                <i className="fa-solid fa-xmark"></i>
                                            </button>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

// DetailsPage (중요 정보)
const DetailsPage = () => {
    const { db, appId, userId, details, setDetails, isAuthReady, openAlert, openConfirm } = useContext(AppContext);
    const [isAddBookingModalOpen, setIsAddBookingModalOpen] = useState(false);
    const [isAddContactModalOpen, setIsAddContactModalOpen] = useState(false);

    // Firestore에 상세 정보 데이터 업데이트
    const updateDetails = async (updatedData) => {
        if (!isAuthReady || !userId) {
            console.error("Firebase not ready or user not authenticated.");
            openAlert("사용자 인증이 완료되지 않았습니다. 상세 정보를 업데이트할 수 없습니다.");
            return;
        }
        try {
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/details`, 'myDetails'), updatedData, { merge: true });
        } catch (e) {
            console.error("Error updating details: ", e);
            // Removed openAlert for error here as per request to remove alert popups
        }
    };

    const handleBookingSave = async (bookingId, field, newValue) => {
        const updatedBookings = details.bookings.map(b =>
            b.id === bookingId ? { ...b, [field]: newValue } : b
        );
        await updateDetails({ ...details, bookings: updatedBookings });
    };

    const handleContactSave = async (contactId, field, newValue) => {
        const updatedContacts = details.contacts.map(c =>
            c.id === contactId ? { ...c, [field]: newValue } : c
        );
        await updateDetails({ ...details, contacts: updatedContacts });
    };

    const handleAddBooking = async (newBookingData) => {
        const updatedBookings = [...details.bookings, newBookingData];
        await updateDetails({ ...details, bookings: updatedBookings });
        // Removed openAlert for success message as per request
    };

    const handleDeleteBooking = async (bookingId) => {
        openConfirm("이 예약 정보를 삭제하시겠습니까?", "예약 삭제", async (confirmed) => {
            if (confirmed) {
                const updatedBookings = details.bookings.filter(b => b.id !== bookingId);
                await updateDetails({ ...details, bookings: updatedBookings });
            }
        });
    };

    const handleAddContact = async (newContactData) => {
        const updatedContacts = [...details.contacts, newContactData];
        await updateDetails({ ...details, contacts: updatedContacts });
        // Removed openAlert for success message as per request
    };

    const handleDeleteContact = async (contactId) => {
        openConfirm("이 연락처를 삭제하시겠습니까?", "연락처 삭제", async (confirmed) => {
            if (confirmed) {
                const updatedContacts = details.contacts.filter(c => c.id !== contactId);
                await updateDetails({ ...details, contacts: updatedContacts });
            }
        });
    };

    // Sort bookings for display on this page
    const groupedAllBookings = groupAndSortBookings(details.bookings);
    const sortedAllBookingTypes = Object.keys(groupedAllBookings).sort();

    return (
        <div className="p-4 md:p-6 bg-slate-50 min-h-screen">
            <h2 className="text-2xl md:text-3xl font-bold text-teal-700 mb-4 text-center">중요 정보</h2>
            <p className="text-slate-600 mb-6 text-center">항공권, 숙소 예약 정보, 비상 연락처 등 중요한 정보들을 이곳에 모아두고 필요할 때 빠르게 확인하고 수정/삭제할 수 있습니다.</p>

            <button
                onClick={() => setIsAddBookingModalOpen(true)}
                className="bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition mb-4 mr-2"
            >
                <i className="fa-solid fa-bookmark mr-2"></i>새 예약 추가
            </button>
            <button
                onClick={() => setIsAddContactModalOpen(true)}
                className="bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition mb-4"
            >
                <i className="fa-solid fa-address-book mr-2"></i>새 연락처 추가
            </button>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* 예약 정보 섹션 */}
                <div>
                    <h3 className="text-xl font-bold mb-3 text-teal-700">예약 정보</h3>
                    <div className="space-y-4">
                        {sortedAllBookingTypes.length > 0 ? (
                            sortedAllBookingTypes.map(type => (
                                <div key={type} className="mb-4"> {/* Vertical spacing between types */}
                                    <h4 className="font-bold text-slate-700 mb-2 text-lg">{type}</h4> {/* Type heading */}
                                    <div className="space-y-2"> {/* Vertical arrangement for bookings of same type */}
                                        {groupedAllBookings[type].map(b => (
                                            <div key={b.id} className="bg-slate-50 p-4 rounded-lg relative group">
                                                <p className="font-semibold">
                                                    <EditableText
                                                        value={b.name}
                                                        onSave={(val) => handleBookingSave(b.id, 'name', val)}
                                                        className="inline-block"
                                                        placeholder="예약명"
                                                    />
                                                    <span className="text-xs font-normal px-2 py-1 rounded-full bg-teal-100 text-teal-800 ml-2">
                                                        <EditableText
                                                            value={b.type}
                                                            onSave={(val) => handleBookingSave(b.id, 'type', val)}
                                                            className="inline-block"
                                                            placeholder="유형"
                                                        />
                                                    </span>
                                                </p>
                                                {b.from && b.to && (
                                                    <p className="text-sm text-slate-500">
                                                        <EditableText
                                                            value={b.from}
                                                            onSave={(val) => handleBookingSave(b.id, 'from', val)}
                                                            className="inline-block"
                                                            placeholder="출발지"
                                                        /> →
                                                        <EditableText
                                                            value={b.to}
                                                            onSave={(val) => handleBookingSave(b.id, 'to', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="도착지"
                                                        />
                                                    </p>
                                                )}
                                                {b.checkin && b.checkout && (
                                                    <p className="text-sm text-slate-500">
                                                        <EditableDate
                                                            value={b.checkin}
                                                            onSave={(val) => handleBookingSave(b.id, 'checkin', val)}
                                                            className="inline-block"
                                                        /> ~
                                                        <EditableDate
                                                            value={b.checkout}
                                                            onSave={(val) => handleBookingSave(b.id, 'checkout', val)}
                                                            className="inline-block ml-1"
                                                        />
                                                    </p>
                                                )}
                                                {(b.type === '항공' || b.type === '열차' || b.type === '버스') && b.boardingDate && ( // Added '버스'
                                                    <p className="text-sm text-slate-500">탑승일:
                                                        <EditableDate
                                                            value={b.boardingDate}
                                                            onSave={(val) => handleBookingSave(b.id, 'boardingDate', val)}
                                                            className="inline-block ml-1"
                                                        />
                                                    </p>
                                                )}
                                                {b.departure && b.arrival && (
                                                    <p className="text-sm text-slate-500">출발:
                                                        <EditableText
                                                            value={b.departure}
                                                            onSave={(val) => handleBookingSave(b.id, 'departure', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="출발 시간"
                                                        /> / 도착:
                                                        <EditableText
                                                            value={b.arrival}
                                                            onSave={(val) => handleBookingSave(b.id, 'arrival', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="도착 시간"
                                                        />
                                                    </p>
                                                )}
                                                {b.date && b.startTime && b.endTime && b.type === "투어" && ( // Changed to startTime/endTime
                                                    <p className="text-sm text-slate-500">날짜:
                                                        <EditableDate
                                                            value={b.date}
                                                            onSave={(val) => handleBookingSave(b.id, 'date', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="날짜"
                                                        /> / 시작:
                                                        <EditableText
                                                            value={b.startTime}
                                                            onSave={(val) => handleBookingSave(b.id, 'startTime', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="시작 시간"
                                                        /> / 종료:
                                                        <EditableText
                                                            value={b.endTime}
                                                            onSave={(val) => handleBookingSave(b.id, 'endTime', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="종료 시간"
                                                        /> / 미팅:
                                                        <EditableText
                                                            value={b.meetingPoint}
                                                            onSave={(val) => handleBookingSave(b.id, 'meetingPoint', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="미팅 장소"
                                                        />
                                                    </p>
                                                )}
                                                {(b.type === '식사' || b.type === '기타') && b.date && b.time && ( // New types
                                                    <p className="text-sm text-slate-500">날짜:
                                                        <EditableDate
                                                            value={b.date}
                                                            onSave={(val) => handleBookingSave(b.id, 'date', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="날짜"
                                                        /> / 시간:
                                                        <EditableText
                                                            value={b.time}
                                                            onSave={(val) => handleBookingSave(b.id, 'time', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="시간"
                                                        />
                                                    </p>
                                                )}
                                                <p className="text-sm text-slate-500">예약번호:
                                                    <EditableText
                                                        value={b.ref}
                                                        onSave={(val) => handleBookingSave(b.id, 'ref', val)}
                                                        className="inline-block ml-1"
                                                        placeholder="예약 번호"
                                                    />
                                                </p>
                                                {b.notes && (
                                                    <p className="text-sm text-slate-500">메모:
                                                        <EditableText
                                                            value={b.notes}
                                                            onSave={(val) => handleBookingSave(b.id, 'notes', val)}
                                                            className="inline-block ml-1"
                                                            placeholder="메모"
                                                        />
                                                    </p>
                                                )}
                                                <button
                                                    onClick={() => handleDeleteBooking(b.id)}
                                                    className="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                                >
                                                    <i className="fa-solid fa-xmark"></i>
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))
                        ) : (
                            <p className="text-slate-500 text-center py-4">등록된 예약 정보가 없습니다.</p>
                        )}
                    </div>
                </div>

                {/* 비상 연락처 섹션 */}
                <div>
                    <h3 className="text-xl font-bold mb-3 text-teal-700">비상 연락처</h3>
                    <div className="space-y-4">
                        {details.contacts.length > 0 ? (
                            details.contacts.map(c => (
                                <div key={c.id} className="bg-slate-50 p-4 rounded-lg relative group">
                                    <p className="font-semibold">
                                        <EditableText
                                            value={c.name}
                                            onSave={(val) => handleContactSave(c.id, 'name', val)}
                                            className="inline-block"
                                            placeholder="이름"
                                        />
                                    </p>
                                    <p className="text-sm text-slate-500">
                                        <EditableText
                                            value={c.info}
                                            onSave={(val) => handleContactSave(c.id, 'info', val)}
                                            className="inline-block"
                                            placeholder="정보"
                                        />
                                    </p>
                                    {c.notes && ( // Display notes if they exist
                                        <p className="text-sm text-slate-500">메모:
                                            <EditableText
                                                value={c.notes}
                                                onSave={(val) => handleContactSave(c.id, 'notes', val)}
                                                className="inline-block ml-1"
                                                placeholder="메모"
                                            />
                                        </p>
                                    )}
                                    <button
                                        onClick={() => handleDeleteContact(c.id)}
                                        className="absolute top-2 right-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                    >
                                        <i className="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                            ))
                        ) : (
                            <p className="text-slate-500 text-center py-4">등록된 연락처가 없습니다.</p>
                        )}
                    </div>
                </div>
            </div>

            <AddBookingModal
                isOpen={isAddBookingModalOpen}
                onClose={() => setIsAddBookingModalOpen(false)}
                onSave={handleAddBooking}
            />

            <AddContactModal
                isOpen={isAddContactModalOpen}
                onClose={() => setIsAddContactModalOpen(false)}
                onSave={handleAddContact}
            />
        </div>
    );
};


// 메인 App 컴포넌트
const App = () => {
    const { currentPage, setCurrentPage, isAuthReady, details, db, appId, userId, setDetails, openAlert, openConfirm } = useContext(AppContext);

    // 서비스 워커 등록 코드가 제거되었습니다.

    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-slate-100">
                <div className="text-lg font-semibold text-slate-700">데이터 로딩 중...</div>
            </div>
        );
    }

    const handleSaveData = async () => {
        if (!userId) {
            openAlert("사용자 인증이 완료되지 않았습니다. 데이터를 저장할 수 없습니다.");
            return;
        }
        openAlert('여행 데이터가 저장되었습니다!');
    };

    const handleLoadData = async () => {
        if (!userId) {
            openAlert("사용자 인증이 완료되지 않았습니다. 데이터를 불러올 수 없습니다.");
            return;
        }
        openAlert('저장된 여행 데이터를 불러왔습니다!');
    };

    const handleTripTitleSave = async (newValue) => {
        if (!userId) return;
        const updatedDetails = { ...details, customTitle: newValue };
        setDetails(updatedDetails);
        try {
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/details`, 'myDetails'), updatedDetails, { merge: true });
        } catch (e) {
            console.error("Error updating trip title:", e);
        }
    };

    const renderPage = () => {
        switch (currentPage) {
            case 'dashboard':
                return <SummaryPage key="dashboard-page" />;
            case 'itinerary':
                return <ItineraryPage key="itinerary-page" />;
            case 'expenses':
                return <ExpensePage key="expenses-page" />;
            case 'checklist':
                return <ChecklistPage key="checklist-page" />;
            case 'info':
                return <DetailsPage key="info-page" />;
            default:
                return <SummaryPage key="dashboard-page-default" />;
        }
    };

    return (
        <div className="font-sans antialiased bg-slate-50">
            <style>
                {`
                @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
                body {
                    font-family: 'Pretendard', sans-serif;
                }
                /* Custom scrollbar for better aesthetics */
                ::-webkit-scrollbar {
                    width: 8px;
                }
                ::-webkit-scrollbar-track {
                    background: #f1f1f1;
                    border-radius: 10px;
                }
                ::-webkit-scrollbar-thumb {
                    background: #888;
                    border-radius: 10px;
                }
                ::-webkit-scrollbar-thumb:hover {
                    background: #555;
                }
                .accordion-content {
                    max-height: 0;
                    overflow: hidden;
                    transition: max-height 0.3s ease-out;
                }
                /* For editable fields focus style */
                input:focus, textarea:focus, select:focus, [contenteditable="true"]:focus {
                    outline: 2px solid #2dd4bf; /* Tailwind teal-400 */
                    border-radius: 4px;
                    padding: 2px 4px;
                    margin: -2px -4px;
                }
                `}
            </style>
            <div className="container mx-auto max-w-5xl p-4 md:p-6">
                <header className="mb-6">
                    <h1 className="text-3xl md:text-4xl font-bold text-teal-700 text-center mb-2">
                        <EditableText
                            value={details.customTitle}
                            onSave={handleTripTitleSave}
                            className="inline-block"
                            placeholder="인터랙티브 여행 플래너"
                        />
                    </h1>
                    <p className="text-center text-slate-500 text-lg">
                        {/* Removed customTitle here as it's now in h1 */}
                    </p>
                    <div className="flex justify-center mt-4 space-x-4">
                        <button onClick={handleSaveData} className="bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition">
                            <i className="fa-solid fa-floppy-disk mr-2"></i>데이터 저장
                        </button>
                        <button onClick={handleLoadData} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">
                            <i className="fa-solid fa-cloud-arrow-down mr-2"></i>데이터 불러오기
                        </button>
                    </div>
                </header>

                <nav className="bg-white rounded-lg shadow-md mb-6 sticky top-0 z-10">
                    <ul className="flex justify-around items-center p-2">
                        <li><button data-target="dashboard" className={`nav-item font-semibold px-4 py-2 text-slate-600 hover:text-teal-600 ${currentPage === 'dashboard' ? 'active text-teal-700 border-b-2 border-teal-700' : ''}`} onClick={() => setCurrentPage('dashboard')}><i className="fa-solid fa-chart-pie mr-2 hidden md:inline-block"></i>대시보드</button></li>
                        <li><button data-target="itinerary" className={`nav-item font-semibold px-4 py-2 text-slate-600 hover:text-teal-600 ${currentPage === 'itinerary' ? 'active text-teal-700 border-b-2 border-teal-700' : ''}`} onClick={() => setCurrentPage('itinerary')}><i className="fa-solid fa-route mr-2 hidden md:inline-block"></i>상세 일정</button></li>
                        <li><button data-target="expenses" className={`nav-item font-semibold px-4 py-2 text-slate-600 hover:text-teal-600 ${currentPage === 'expenses' ? 'active text-teal-700 border-b-2 border-teal-700' : ''}`} onClick={() => setCurrentPage('expenses')}><i className="fa-solid fa-wallet mr-2 hidden md:inline-block"></i>경비 관리</button></li>
                        <li><button data-target="checklist" className={`nav-item font-semibold px-4 py-2 text-slate-600 hover:text-teal-600 ${currentPage === 'checklist' ? 'active text-teal-700 border-b-2 border-teal-700' : ''}`} onClick={() => setCurrentPage('checklist')}><i className="fa-solid fa-list-check mr-2 hidden md:inline-block"></i>체크리스트</button></li>
                        <li><button data-target="info" className={`nav-item font-semibold px-4 py-2 text-slate-600 hover:text-teal-600 ${currentPage === 'info' ? 'active text-teal-700 border-b-2 border-teal-700' : ''}`} onClick={() => setCurrentPage('info')}><i className="fa-solid fa-circle-info mr-2 hidden md:inline-block"></i>중요 정보</button></li>
                    </ul>
                </nav>

                <main>
                    {renderPage()}
                </main>
            </div>
            {/* Font Awesome CDN */}
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        </div>
    );
};

// AppProvider로 App을 감싸서 Context를 제공
export default function ProvidedApp() {
    return (
        <AppProvider>
            <App />
        </AppProvider>
    );
}
